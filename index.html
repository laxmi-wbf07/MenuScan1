<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Druk Appetite — a premium Bhutanese menu: Ema Datshi, Momos, Phaksha Paa and more."><meta name=theme-color content="#c76b2a"><title>Druk Appetite — Menu</title><link rel=preconnect href=https://images.unsplash.com><link rel=preconnect href=https://raw.githubusercontent.com><style>*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#14110f;color:#fff;overflow:hidden;-webkit-tap-highlight-color:transparent}header{position:fixed;inset:0 0 auto 0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;z-index:9;background:rgba(20,17,15,.92);backdrop-filter:blur(10px);border-bottom:1px solid rgba(199,107,42,.35)}h1{margin:0;font-size:18px;letter-spacing:.4px;font-weight:650}.stars{font-weight:700;display:flex;align-items:center;gap:8px}.stars b{font-size:18px;color:#ffd36b}main{height:100vh;display:flex;overflow-x:auto;overflow-y:hidden;scroll-snap-type:x mandatory;scroll-behavior:smooth;-webkit-overflow-scrolling:touch}main::-webkit-scrollbar{display:none}.card{--a:#c76b2a;min-width:100vw;width:100vw;height:100vh;scroll-snap-align:start;scroll-snap-stop:always;position:relative;perspective:1700px;outline:0;border:0;background:transparent;padding:0;color:inherit;cursor:pointer;touch-action:manipulation}.inner{height:100%;width:100%;transform-style:preserve-3d;transition:transform .6s cubic-bezier(.4,0,.2,1)}.card.flipped .inner{transform:rotateY(180deg)}.face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden}.front{background:#000}.hero{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scale(1);filter:saturate(1.05) contrast(1.02)}.card.snapped .hero{animation:kb 3s ease-out both}@keyframes kb{from{transform:scale(1)}to{transform:scale(1.08)}}.shade{position:absolute;inset:auto 0 0 0;padding:28px 18px 18px;background:linear-gradient(180deg,rgba(0,0,0,0),rgba(0,0,0,.82))}.name{font-size:34px;font-weight:750;line-height:1.05;text-shadow:0 2px 18px rgba(0,0,0,.65)}.hint{margin-top:10px;font-size:13px;opacity:.85}.accent{color:var(--a)}.back{transform:rotateY(180deg);background:linear-gradient(180deg,rgba(20,17,15,.92),rgba(20,17,15,.98));display:flex;flex-direction:column;gap:14px;align-items:center;justify-content:center;padding:84px 22px 28px;text-align:center}.price{font-size:64px;font-weight:800;letter-spacing:-1px;color:var(--a)}.dz{font-size:18px;opacity:.92;font-style:italic}.en{max-width:42rem;font-size:16px;line-height:1.55;opacity:.9}.cal{font-size:13px;letter-spacing:.12em;text-transform:uppercase;opacity:.72}.tip{max-width:42rem;border:1px solid rgba(255,255,255,.18);background:rgba(199,107,42,.12);padding:14px 14px;border-radius:10px}.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);z-index:10;background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.16);padding:10px 14px;border-radius:999px;font-size:13px;opacity:0;transition:opacity .2s ease}.toast.show{opacity:1}.badge{position:fixed;top:64px;right:14px;z-index:10;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.14);padding:6px 10px;border-radius:999px;font-size:12px;display:none}noscript{display:block;padding:80px 16px}a{color:#ffd36b}</style></head><body><header><h1>Druk Appetite</h1><div class=stars aria-label="Favorites"><span aria-hidden=true>⭐</span><b id=starn>0</b></div></header><div class=badge id=offline>Offline</div><div class=toast id=toast role=status aria-live=polite></div><main id=scroller aria-label="Menu filmstrip"></main><noscript>This menu requires JavaScript to run offline and sync updates.</noscript><script>(()=>{'use strict';const $=s=>document.querySelector(s),sc=$('#scroller'),st=$('#starn'),off=$('#offline'),toast=$('#toast');const DB='druk-appetite',V=1,S='dishes',REPO='laxmi-wbf07/MenuScan1',BR=['main','master','gh-pages'];const FALL='#c76b2a';let db,menuUrl=localStorage.getItem('menu-url')||'',etag=localStorage.getItem('menu-etag')||'',dishes=[],fav=JSON.parse(localStorage.getItem('favorites')||'[]');const urls=()=>{const rel=new URL('menu.md',location.href).href;const raw=BR.map(b=>`https://raw.githubusercontent.com/${REPO}/${b}/menu.md`);const a=[menuUrl,...raw,rel].filter(Boolean);return [...new Set(a)]};const unq=s=>{s=(s||'').trim();if((s[0]==='"'&&s.at(-1)==='"')||(s[0]==="'"&&s.at(-1)==="'"))s=s.slice(1,-1);return s};const show=(m,ms=900)=>{toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),ms)};const stars=()=>{st.textContent=fav.length;const unlocked=fav.length>=5;return unlocked};function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,V);r.onerror=()=>rej(r.error);r.onsuccess=()=>res(r.result);r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains(S))d.createObjectStore(S,{keyPath:'name'})}})}function tx(mode,fn){return new Promise((res,rej)=>{const t=db.transaction(S,mode),os=t.objectStore(S);fn(os);t.oncomplete=()=>res();t.onerror=()=>rej(t.error)})}function all(){return new Promise((res,rej)=>{const r=db.transaction(S,'readonly').objectStore(S).getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error)})}async function replace(list){const prev=await all(),c=new Map(prev.map(d=>[d.name,d.color]));await tx('readwrite',os=>os.clear());await tx('readwrite',os=>list.forEach(d=>{if(!d.color&&c.get(d.name))d.color=c.get(d.name);os.put(d)}))}function parse(t){const out=[];let o=null;for(const raw of t.replace(/\r/g,'').split('\n')){const line=raw.trim();const m=line.match(/^[-]\s+name:\s*(.+)$/);if(m){if(o)out.push(o);o={name:unq(m[1])};continue}if(!o)continue;const kv=line.match(/^([a-z_]+):\s*(.*)$/);if(!kv)continue;const k=kv[1],v=unq(kv[2]);if(k==='hero_url')o.hero_url=v;else if(k==='price_btn')o.price=+v;else if(k==='description_english')o.description_en=v;else if(k==='description_dzongkha')o.description_dz=v;else if(k==='calories')o.calories=+v;else if(k==='ashi_tip')o.ashi_tip=v}if(o)out.push(o);return out.filter(d=>d.name&&d.hero_url)}async function fetchMenu(){const h=etag?{'If-None-Match':etag}:{},u=urls();for(const url of u){try{const r=await fetch(url,{headers:h,cache:'no-store'});if(r.status===304){menuUrl=url;localStorage.setItem('menu-url',menuUrl);return null}if(!r.ok)continue;const e=r.headers.get('ETag');if(e){etag=e;localStorage.setItem('menu-etag',etag)}menuUrl=url;localStorage.setItem('menu-url',menuUrl);const t=await r.text();const list=parse(t).map(d=>({name:d.name,price:d.price||0,description_en:d.description_en||'',description_dz:d.description_dz||'',calories:d.calories||0,hero_url:d.hero_url,color:d.color||'',ashi_tip:d.ashi_tip||''}));await replace(list);return list}catch{}}return null}function lumin(r,g,b){return(0.2126*r+0.7152*g+0.0722*b)/255}function toCol(img){try{const c=document.createElement('canvas'),x=c.getContext('2d',{willReadFrequently:!0});c.width=10;c.height=10;x.drawImage(img,0,0,10,10);const pts=[[5,5],[1,1],[8,1],[1,8],[8,8]];let r=0,g=0,b=0,n=0;for(const[p,q]of pts){const d=x.getImageData(p,q,1,1).data;r+=d[0];g+=d[1];b+=d[2];n++}r=Math.round(r/n);g=Math.round(g/n);b=Math.round(b/n);if(lumin(r,g,b)<.35){r=Math.round(r*.62+199*.38);g=Math.round(g*.62+107*.38);b=Math.round(b*.62+42*.38)}return`rgb(${r},${g},${b})`}catch{return FALL}}function card(d,first){const unlocked=stars();const tip=unlocked&&d.ashi_tip?`<div class=tip><span class=accent>Ashi’s tip:</span> ${d.ashi_tip}</div>`:'';const el=document.createElement('button');el.type='button';el.className='card';el.style.setProperty('--a',d.color||FALL);el.setAttribute('aria-label',`${d.name}. Tap to flip. Double-tap to favorite.`);el.innerHTML=`<div class=inner><div class="face front"><img class=hero src="${first?d.hero_url:''}" data-src="${d.hero_url}" crossorigin=anonymous alt="${d.name}" decoding=async><div class=shade><div class=name>${d.name}</div><div class=hint><span class=accent>Tap</span> flip · <span class=accent>Double-tap</span> ⭐</div></div></div><div class="face back"><div class=back><div class=price>Nu. ${d.price||0}</div><div class=dz>${d.description_dz||''}</div><div class=en>${d.description_en||''}</div><div class=cal>${d.calories||0} cal</div>${tip}</div></div></div>`;let t=0,timer=0,sx=0;el.addEventListener('pointerdown',e=>{sx=e.clientX},{passive:!0});el.addEventListener('pointerup',e=>{if(Math.abs(e.clientX-sx)>10)return;const now=performance.now();if(now-t<280){t=0;clearTimeout(timer);fav.push(d.name);localStorage.setItem('favorites',JSON.stringify(fav));const u=stars();show('Saved ⭐');if(u&&fav.length===5)render(!0)}else{t=now;timer=setTimeout(()=>el.classList.toggle('flipped'),280)}},{passive:!0});el.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){el.classList.toggle('flipped')}});return el}function render(keepPos){const w=innerWidth,idx=keepPos?Math.round(sc.scrollLeft/w):0;sc.innerHTML='';dishes.forEach((d,i)=>sc.appendChild(card(d,i===0)));lazy();snap();if(keepPos)sc.scrollTo({left:idx*w,behavior:'auto'})}let ioImg,ioSnap;function lazy(){ioImg&&ioImg.disconnect();ioImg=new IntersectionObserver(es=>{for(const e of es)if(e.isIntersecting){const img=e.target,btn=img.closest('.card');if(!img._b){img._b=1;img.onerror=()=>{img.removeAttribute('src');img.style.background='linear-gradient(135deg,#2b211d,#14110f)'}}if(img.dataset.src&&!img.src)img.src=img.dataset.src;const name=btn?.querySelector('.name')?.textContent||'',dish=dishes.find(x=>x.name===name);if(dish&&!dish.color){const run=async()=>{if(dish.color)return;const c=toCol(img);dish.color=c;btn&&btn.style.setProperty('--a',c);await tx('readwrite',os=>os.put(dish))};if(img.complete&&img.naturalWidth)run();else img.addEventListener('load',run,{once:!0})}ioImg.unobserve(img)}},{root:sc,rootMargin:'0px 50% 0px 50%',threshold:.01});sc.querySelectorAll('img.hero').forEach(i=>ioImg.observe(i))}function snap(){ioSnap&&ioSnap.disconnect();ioSnap=new IntersectionObserver(es=>{for(const e of es)if(e.intersectionRatio>.86){sc.querySelector('.snapped')?.classList.remove('snapped');e.target.classList.add('snapped')}},{root:sc,threshold:[.5,.86,.95]});sc.querySelectorAll('.card').forEach(c=>ioSnap.observe(c));requestAnimationFrame(()=>sc.querySelector('.card')?.classList.add('snapped'))}function net(){const on=()=>off.style.display=navigator.onLine?'none':'block';addEventListener('online',on);addEventListener('offline',on);on()}async function init(){net();db=await openDB();dishes=await all();if(dishes.length){render();fetchMenu().then(n=>{if(n){dishes=n;render(!0)}})}else{const n=await fetchMenu();dishes=n||await all();if(!dishes.length){sc.innerHTML='<div style="padding:88px 18px;max-width:34rem;opacity:.9">Menu unavailable offline. Go online once to cache <a href="menu.md">menu.md</a>.</div>';return}render()}setInterval(()=>fetchMenu().then(n=>{if(n){dishes=n;render(!0)}}),6e4)}init()})()</script></body></html>
